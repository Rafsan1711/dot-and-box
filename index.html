<!DOCTYPE html>
<html lang="en" class="bg-gray-50 text-gray-900" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Bookstore</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen flex flex-col">

  <!-- AUTH SECTION -->
  <main id="auth-section" class="max-w-md mx-auto mt-12 p-6 bg-white rounded shadow-md">
    <h1 class="text-3xl font-bold mb-6 text-center">Welcome to BookStore</h1>

    <!-- Register Form -->
    <form id="register-form" class="mb-4 hidden">
      <h2 class="text-xl font-semibold mb-3">Register</h2>
      <input id="reg-email" type="email" placeholder="Email" required class="w-full p-2 mb-2 border rounded"/>
      <input id="reg-password" type="password" placeholder="Password" required class="w-full p-2 mb-2 border rounded"/>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded">Register</button>
      <p class="mt-3 text-center text-sm">Already have an account? <button id="show-login" type="button" class="text-blue-600 hover:underline">Login</button></p>
    </form>

    <!-- Login Form -->
    <form id="login-form" class="mb-4">
      <h2 class="text-xl font-semibold mb-3">Login</h2>
      <input id="login-email" type="email" placeholder="Email" required class="w-full p-2 mb-2 border rounded"/>
      <input id="login-password" type="password" placeholder="Password" required class="w-full p-2 mb-2 border rounded"/>
      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded">Login</button>
      <p class="mt-3 text-center text-sm">Don't have an account? <button id="show-register" type="button" class="text-green-600 hover:underline">Register</button></p>
    </form>

    <!-- Google Sign-in -->
    <div class="text-center mt-4">
      <button id="google-signin" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 48 48"><path fill="#fbc02d" d="M43.611 20.083h-1.84v-.082H24v8.001h11.18c-1.05 5.367-5.583 9.2-11.18 9.2-6.633 0-12-5.367-12-12s5.367-12 12-12c3.063 0 5.83 1.177 7.934 3.101l5.651-5.653C34.845 7.514 29.712 6 24 6 12.954 6 4 14.954 4 26s8.954 20 20 20c11.046 0 20-8.954 20-20 0-1.34-.14-2.647-.389-3.917z"/></svg>
        Sign in with Google
      </button>
    </div>
  </main>

  <!-- APP SECTION -->
  <section id="app-section" class="hidden flex-grow flex flex-col max-w-6xl mx-auto p-4 space-y-6">

    <!-- HEADER -->
    <header class="flex justify-between items-center border-b pb-4">
      <h1 class="text-4xl font-extrabold tracking-tight">Online Bookstore</h1>
      <div>
        <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
      </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="flex space-x-4 border-b pb-2">
      <button data-section="home" class="nav-btn px-4 py-2 font-semibold border-b-2 border-blue-600 text-blue-600">Home</button>
      <button data-section="wishlist" class="nav-btn px-4 py-2 font-semibold hover:text-blue-600">Wishlist</button>
      <button data-section="cart" class="nav-btn px-4 py-2 font-semibold hover:text-blue-600">Cart</button>
    </nav>

    <!-- SEARCH BAR -->
    <div class="mt-4">
      <input type="text" id="search-input" placeholder="Search books by name..." class="w-full p-2 border rounded" />
      <div id="search-results" class="mt-2 bg-white rounded shadow max-h-60 overflow-auto hidden"></div>
    </div>

    <!-- SECTIONS -->
    <div id="sections" class="flex-grow overflow-auto">

      <!-- HOME SECTION -->
      <section id="home-section" class="pt-6">
        <!-- Owner controls -->
        <div id="owner-controls" class="mb-6 space-x-4 hidden">
          <button id="add-category-btn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Add Category</button>
          <button id="add-book-btn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Add Book</button>
        </div>

        <div id="categories-container" class="space-y-8">
          <!-- Categories and books go here -->
        </div>
      </section>

      <!-- WISHLIST SECTION -->
      <section id="wishlist-section" class="hidden pt-6">
        <h2 class="text-2xl font-semibold mb-4">Your Wishlist</h2>
        <div id="wishlist-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
      </section>

      <!-- CART SECTION -->
      <section id="cart-section" class="hidden pt-6">
        <h2 class="text-2xl font-semibold mb-4">Your Cart</h2>
        <div id="cart-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
      </section>

      <!-- BOOK DETAIL SECTION (hidden by default) -->
      <section id="book-detail-section" class="hidden pt-6 max-w-xl mx-auto">
        <button id="back-home-btn" class="mb-4 text-blue-600 hover:underline">&larr; Back to Home</button>
        <div class="bg-white rounded shadow p-6">
          <img id="detail-thumbnail" src="" alt="Book thumbnail" class="w-full h-72 object-contain mb-4 mx-auto" />
          <h2 id="detail-title" class="text-3xl font-bold mb-2"></h2>
          <h3 id="detail-author" class="text-xl text-gray-700 mb-4"></h3>

          <h4 class="text-lg font-semibold mb-2">Comments</h4>
          <div id="comments-list" class="mb-4 max-h-40 overflow-auto border p-2 rounded bg-gray-50"></div>

          <form id="comment-form" class="flex gap-2">
            <input id="comment-input" type="text" placeholder="Add a comment..." required class="flex-grow p-2 border rounded" />
            <button type="submit" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Post</button>
          </form>
        </div>
      </section>
    </div>
  </section>

  <!-- MODAL BACKDROP -->
  <div id="modal-bg" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div id="modal" class="bg-white rounded shadow-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto"></div>
  </div>

<script>
  // Firebase config (এখানে তোমার প্রকৃত ফায়ারবেস কনফিগ বসাও)
  const firebaseConfig = {
  apiKey: "AIzaSyB-5CakD79CthsI-_vcqblOCN1sXS6U8u8",
  authDomain: "dot-and-box-90d27.firebaseapp.com",
  databaseURL: "https://dot-and-box-90d27-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dot-and-box-90d27",
  storageBucket: "dot-and-box-90d27.firebasestorage.app",
  messagingSenderId: "913945926983",
  appId: "1:913945926983:web:b4c00c2cffff5b6fa7c062"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const OWNER_EMAIL = "18272872@gmail.com";

  // DOM Elements
  const authSection = document.getElementById('auth-section');
  const appSection = document.getElementById('app-section');
  const logoutBtn = document.getElementById('logout-btn');

  const registerForm = document.getElementById('register-form');
  const loginForm = document.getElementById('login-form');
  const showRegisterBtn = document.getElementById('show-register');
  const showLoginBtn = document.getElementById('show-login');

  const googleSignInBtn = document.getElementById('google-signin');

  const navButtons = document.querySelectorAll('.nav-btn');
  const sections = {
    home: document.getElementById('home-section'),
    wishlist: document.getElementById('wishlist-section'),
    cart: document.getElementById('cart-section'),
    bookDetail: document.getElementById('book-detail-section')
  };

  const ownerControls = document.getElementById('owner-controls');
  const addCategoryBtn = document.getElementById('add-category-btn');
  const addBookBtn = document.getElementById('add-book-btn');

  const categoriesContainer = document.getElementById('categories-container');
  const wishlistContainer = document.getElementById('wishlist-container');
  const cartContainer = document.getElementById('cart-container');

  const modalBg = document.getElementById('modal-bg');
  const modal = document.getElementById('modal');

  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  // Book Detail Elements
  const backHomeBtn = document.getElementById('back-home-btn');
  const detailThumbnail = document.getElementById('detail-thumbnail');
  const detailTitle = document.getElementById('detail-title');
  const detailAuthor = document.getElementById('detail-author');
  const commentsList = document.getElementById('comments-list');
  const commentForm = document.getElementById('comment-form');
  const commentInput = document.getElementById('comment-input');

  let currentUser = null;
  let currentSection = 'home';
  let currentBookId = null;

  // Show Register/Login toggle
  showRegisterBtn.addEventListener('click', () => {
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
  });
  showLoginBtn.addEventListener('click', () => {
    registerForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
  });

  // Register handler
  registerForm.addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      await userCredential.user.sendEmailVerification();
      alert('Verification email sent. Please verify your email before login.');
      registerForm.reset();
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    } catch (err) {
      alert(err.message);
    }
  });

  // Login handler
  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      if (!userCredential.user.emailVerified) {
        alert('Please verify your email before logging in.');
        await auth.signOut();
        return;
      }
      loginForm.reset();
    } catch (err) {
      alert(err.message);
    }
  });

  // Google sign-in
  googleSignInBtn.addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const result = await auth.signInWithPopup(provider);
      currentUser = result.user;
      if (!currentUser.emailVerified) {
        await currentUser.sendEmailVerification();
        alert('Verification email sent to your Google account email. Please verify to continue.');
        await auth.signOut();
      }
    } catch (err) {
      alert(err.message);
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Navigation buttons
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      navButtons.forEach(b => b.classList.remove('border-blue-600', 'text-blue-600'));
      btn.classList.add('border-blue-600', 'text-blue-600');
      changeSection(btn.dataset.section);
    });
  });

  // Change visible section function
  function changeSection(sectionName) {
    Object.values(sections).forEach(sec => sec.classList.add('hidden'));
    sections[sectionName].classList.remove('hidden');
    currentSection = sectionName;

    if(sectionName === 'home'){
      loadCategoriesAndBooks();
      searchResults.classList.add('hidden');
    }
    if(sectionName === 'wishlist'){
      loadWishlist();
    }
    if(sectionName === 'cart'){
      loadCart();
    }
    if(sectionName === 'bookDetail'){
      // no extra action now
    }
  }

  // Modal helpers
  function showModal(contentHtml) {
    modal.innerHTML = contentHtml;
    modalBg.classList.remove('hidden');
  }
  function closeModal() {
    modalBg.classList.add('hidden');
    modal.innerHTML = '';
  }
  modalBg.addEventListener('click', e => {
    if(e.target === modalBg) closeModal();
  });

  // Load categories and books
  async function loadCategoriesAndBooks(){
    categoriesContainer.innerHTML = 'Loading...';
    try {
      const snapshot = await db.ref('categories').once('value');
      const categories = snapshot.val() || {};
      categoriesContainer.innerHTML = '';

      for(const [catId, catName] of Object.entries(categories)){
        // Category div
        const catDiv = document.createElement('div');
        catDiv.className = 'category-section';

        const catTitle = document.createElement('h3');
        catTitle.textContent = catName;
        catTitle.className = 'text-2xl font-bold mb-3 border-b pb-1';
        catDiv.appendChild(catTitle);

        // Fetch books of this category
        const booksSnapshot = await db.ref('books').orderByChild('categoryId').equalTo(catId).once('value');
        const books = booksSnapshot.val() || {};

        if(Object.keys(books).length === 0){
          const noBooksMsg = document.createElement('p');
          noBooksMsg.textContent = 'No books in this category yet.';
          noBooksMsg.className = 'mb-4 italic text-gray-600';
          catDiv.appendChild(noBooksMsg);
        } else {
          const booksGrid = document.createElement('div');
          booksGrid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6';

          for(const [bookId, book] of Object.entries(books)){
            const bookCard = createBookCard(book, bookId);
            booksGrid.appendChild(bookCard);
          }

          catDiv.appendChild(booksGrid);
        }

        categoriesContainer.appendChild(catDiv);
      }
    } catch(err){
      categoriesContainer.innerHTML = `<p class="text-red-600">Error loading categories/books: ${err.message}</p>`;
    }
  }

  // Create book card DOM element for Home & Wishlist & Cart
  function createBookCard(book, bookId){
    const card = document.createElement('div');
    card.className = "border rounded shadow p-3 flex flex-col cursor-pointer hover:shadow-lg transition";

    // Thumbnail image
    const img = document.createElement('img');
    img.src = book.coverUrl || 'https://via.placeholder.com/150x200?text=No+Image';
    img.alt = book.title;
    img.className = "w-full h-48 object-contain mb-2 rounded";
    card.appendChild(img);

    // Book title below thumbnail
    const title = document.createElement('h4');
    title.textContent = book.title;
    title.className = "font-semibold text-center";
    card.appendChild(title);

    // Click to open detail page
    card.addEventListener('click', () => openBookDetail(bookId));

    // For non-owner users, add Wishlist & Cart buttons inside detail page only, so no buttons here

    return card;
  }

  // Open Book Detail Page
  async function openBookDetail(bookId){
    currentBookId = bookId;
    // Fetch book info
    try {
      const bookSnap = await db.ref('books/'+bookId).once('value');
      const book = bookSnap.val();
      if(!book) {
        alert('Book not found');
        return;
      }

      detailThumbnail.src = book.coverUrl || 'https://via.placeholder.com/300x400?text=No+Image';
      detailTitle.textContent = book.title;
      detailAuthor.textContent = book.author || 'Unknown author';

      // Show owner controls for editing book info
      if(currentUser.email === OWNER_EMAIL){
        showEditBookModal(bookId, book);
      }

      // Load comments
      loadComments(bookId);

      // Show section
      changeSection('bookDetail');
    } catch(err){
      alert('Failed to load book details: ' + err.message);
    }
  }

  // Show Edit Book Modal (Owner only)
  function showEditBookModal(bookId, book){
    // Add an Edit button at the top right of book detail section
    // Only one edit button - prevent duplicates
    if(document.getElementById('edit-book-btn')) return;

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit Book Info';
    editBtn.id = 'edit-book-btn';
    editBtn.className = 'bg-yellow-500 text-white px-3 py-1 rounded float-right mb-4 hover:bg-yellow-600';

    detailTitle.parentNode.insertBefore(editBtn, detailTitle.nextSibling);

    editBtn.addEventListener('click', () => {
      showModal(`
        <h3 class="text-xl font-bold mb-4">Edit Book Info</h3>
        <form id="edit-book-form" class="space-y-3">
          <input type="text" id="edit-title" placeholder="Book Title" value="${escapeHtml(book.title)}" required class="w-full p-2 border rounded"/>
          <input type="text" id="edit-author" placeholder="Author" value="${escapeHtml(book.author || '')}" class="w-full p-2 border rounded"/>
          <input type="url" id="edit-coverUrl" placeholder="Cover Image URL" value="${escapeHtml(book.coverUrl || '')}" class="w-full p-2 border rounded"/>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancel-edit" class="px-4 py-2 border rounded">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
          </div>
        </form>
      `);

      document.getElementById('cancel-edit').addEventListener('click', closeModal);

      document.getElementById('edit-book-form').addEventListener('submit', async e => {
        e.preventDefault();
        const newTitle = document.getElementById('edit-title').value.trim();
        const newAuthor = document.getElementById('edit-author').value.trim();
        const newCoverUrl = document.getElementById('edit-coverUrl').value.trim();

        try {
          await db.ref('books/'+bookId).update({
            title: newTitle,
            author: newAuthor,
            coverUrl: newCoverUrl
          });
          closeModal();
          // Refresh detail page & home
          openBookDetail(bookId);
          loadCategoriesAndBooks();
          alert('Book info updated successfully.');
        } catch(err){
          alert('Failed to update book: ' + err.message);
        }
      });
    });
  }

  // Escape HTML to prevent injection in modal inputs
  function escapeHtml(text) {
    if(!text) return '';
    return text.replace(/[&<>"']/g, (m) => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'": '&#39;'
    })[m]);
  }

  // Load comments for a book
  async function loadComments(bookId){
    commentsList.innerHTML = 'Loading comments...';
    try {
      const snap = await db.ref('comments/'+bookId).once('value');
      const comments = snap.val() || {};
      commentsList.innerHTML = '';
      if(Object.keys(comments).length === 0){
        commentsList.textContent = 'No comments yet.';
        return;
      }
      // Show each comment
      for(const [key, comment] of Object.entries(comments)){
        const div = document.createElement('div');
        div.className = 'mb-2 p-2 bg-white rounded shadow-sm';
        div.textContent = comment.text;
        commentsList.appendChild(div);
      }
    } catch(err){
      commentsList.innerHTML = `<p class="text-red-600">Failed to load comments: ${err.message}</p>`;
    }
  }

  // Post comment form submit
  commentForm.addEventListener('submit', async e => {
    e.preventDefault();
    const text = commentInput.value.trim();
    if(!text) return;
    if(!currentBookId) return alert('No book selected');

    try {
      const newCommentRef = db.ref('comments/'+currentBookId).push();
      await newCommentRef.set({
        text,
        user: currentUser.email,
        timestamp: Date.now()
      });
      commentInput.value = '';
      loadComments(currentBookId);
    } catch(err){
      alert('Failed to post comment: ' + err.message);
    }
  });

  // Back to home button on detail page
  backHomeBtn.addEventListener('click', () => {
    // Remove edit button if exists
    const editBtn = document.getElementById('edit-book-btn');
    if(editBtn) editBtn.remove();
    changeSection('home');
  });

  // Owner controls: Add category & Add book
  addCategoryBtn.addEventListener('click', () => {
    showModal(`
      <h3 class="text-xl font-bold mb-4">Add Category</h3>
      <form id="add-category-form" class="space-y-3">
        <input type="text" id="category-name" placeholder="Category name" required class="w-full p-2 border rounded" />
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancel-add-category" class="px-4 py-2 border rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add</button>
        </div>
      </form>
    `);

    document.getElementById('cancel-add-category').addEventListener('click', closeModal);

    document.getElementById('add-category-form').addEventListener('submit', async e => {
      e.preventDefault();
      const catName = document.getElementById('category-name').value.trim();
      if(!catName) return alert('Category name required');
      try {
        // Use push to generate unique ID
        const catRef = db.ref('categories').push();
        await catRef.set(catName);
        closeModal();
        loadCategoriesAndBooks();
        alert('Category added');
      } catch(err){
        alert('Failed to add category: ' + err.message);
      }
    });
  });

  addBookBtn.addEventListener('click', async () => {
    // Fetch categories for dropdown
    let categories = {};
    try {
      const snap = await db.ref('categories').once('value');
      categories = snap.val() || {};
    } catch(e){
      alert('Failed to load categories for book addition');
      return;
    }

    // Build category options
    let optionsHtml = '<option value="">Select Category</option>';
    for(const [id, name] of Object.entries(categories)){
      optionsHtml += `<option value="${id}">${name}</option>`;
    }

    showModal(`
      <h3 class="text-xl font-bold mb-4">Add Book</h3>
      <form id="add-book-form" class="space-y-3">
        <input type="text" id="book-title" placeholder="Book title" required class="w-full p-2 border rounded" />
        <input type="text" id="book-author" placeholder="Author" class="w-full p-2 border rounded" />
        <input type="url" id="book-coverUrl" placeholder="Cover image URL" class="w-full p-2 border rounded" />
        <input type="number" id="book-price" placeholder="Price (optional)" min="0" step="any" class="w-full p-2 border rounded" />
        <select id="book-category" required class="w-full p-2 border rounded">${optionsHtml}</select>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancel-add-book" class="px-4 py-2 border rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add</button>
        </div>
      </form>
    `);

    document.getElementById('cancel-add-book').addEventListener('click', closeModal);

    document.getElementById('add-book-form').addEventListener('submit', async e => {
      e.preventDefault();
      const title = document.getElementById('book-title').value.trim();
      const author = document.getElementById('book-author').value.trim();
      const coverUrl = document.getElementById('book-coverUrl').value.trim();
      const priceStr = document.getElementById('book-price').value.trim();
      const price = priceStr ? parseFloat(priceStr) : null;
      const categoryId = document.getElementById('book-category').value;

      if(!title || !categoryId) return alert('Title and category are required.');

      try {
        const newBookRef = db.ref('books').push();
        await newBookRef.set({
          title,
          author,
          coverUrl,
          price,
          categoryId
        });
        closeModal();
        loadCategoriesAndBooks();
        alert('Book added');
      } catch(err){
        alert('Failed to add book: ' + err.message);
      }
    });
  });

  // Wishlist functions
  async function loadWishlist(){
    wishlistContainer.innerHTML = 'Loading...';
    try {
      const snap = await db.ref('wishlist/'+currentUser.uid).once('value');
      const wishlist = snap.val() || {};
      wishlistContainer.innerHTML = '';
      if(Object.keys(wishlist).length === 0){
        wishlistContainer.textContent = 'Your wishlist is empty.';
        return;
      }
      for(const bookId of Object.keys(wishlist)){
        const bookSnap = await db.ref('books/'+bookId).once('value');
        const book = bookSnap.val();
        if(book){
          const card = createBookCard(book, bookId);
          wishlistContainer.appendChild(card);
        }
      }
    } catch(err){
      wishlistContainer.innerHTML = `<p class="text-red-600">Failed to load wishlist: ${err.message}</p>`;
    }
  }

  async function addToWishlist(bookId){
    if(!currentUser) return alert('You must be logged in');
    try {
      await db.ref(`wishlist/${currentUser.uid}/${bookId}`).set(true);
      alert('Added to wishlist');
    } catch(err){
      alert('Failed to add wishlist: ' + err.message);
    }
  }

  // Cart functions
  async function loadCart(){
    cartContainer.innerHTML = 'Loading...';
    try {
      const snap = await db.ref('cart/'+currentUser.uid).once('value');
      const cart = snap.val() || {};
      cartContainer.innerHTML = '';
      if(Object.keys(cart).length === 0){
        cartContainer.textContent = 'Your cart is empty.';
        return;
      }
      for(const bookId of Object.keys(cart)){
        const bookSnap = await db.ref('books/'+bookId).once('value');
        const book = bookSnap.val();
        if(book){
          const card = createBookCard(book, bookId);
          cartContainer.appendChild(card);
        }
      }
    } catch(err){
      cartContainer.innerHTML = `<p class="text-red-600">Failed to load cart: ${err.message}</p>`;
    }
  }

  async function addToCart(bookId){
    if(!currentUser) return alert('You must be logged in');
    try {
      await db.ref(`cart/${currentUser.uid}/${bookId}`).set(true);
      alert('Added to cart');
    } catch(err){
      alert('Failed to add to cart: ' + err.message);
    }
  }

  // Enhance createBookCard to add wishlist & cart buttons on detail page (or optionally here)
  // But since buttons are needed only in detail page, we add buttons there:

  // Modify openBookDetail to add Wishlist & Cart buttons below author

  // Adjust openBookDetail function to add wishlist & cart buttons below author:
  async function openBookDetail(bookId){
    currentBookId = bookId;
    try {
      const bookSnap = await db.ref('books/'+bookId).once('value');
      const book = bookSnap.val();
      if(!book) {
        alert('Book not found');
        return;
      }

      detailThumbnail.src = book.coverUrl || 'https://via.placeholder.com/300x400?text=No+Image';
      detailTitle.textContent = book.title;
      detailAuthor.textContent = book.author || 'Unknown author';

      // Remove existing wishlist/cart buttons if any
      const existingBtns = document.getElementById('wishlist-cart-buttons');
      if(existingBtns) existingBtns.remove();

      // Create wishlist/cart buttons container
      const btnContainer = document.createElement('div');
      btnContainer.id = 'wishlist-cart-buttons';
      btnContainer.className = 'flex gap-4 mb-4 justify-center';

      // Add to wishlist button
      const wishlistBtn = document.createElement('button');
      wishlistBtn.textContent = 'Add to Wishlist';
      wishlistBtn.className = 'bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700';
      wishlistBtn.onclick = () => addToWishlist(bookId);
      btnContainer.appendChild(wishlistBtn);

      // Add to cart button
      const cartBtn = document.createElement('button');
      cartBtn.textContent = 'Add to Cart';
      cartBtn.className = 'bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600';
      cartBtn.onclick = () => addToCart(bookId);
      btnContainer.appendChild(cartBtn);

      // Append buttons after author
      detailAuthor.parentNode.insertBefore(btnContainer, detailAuthor.nextSibling);

      // Owner controls
      if(currentUser.email === OWNER_EMAIL){
        showEditBookModal(bookId, book);
      } else {
        // Remove edit button if exists (for non-owner)
        const editBtn = document.getElementById('edit-book-btn');
        if(editBtn) editBtn.remove();
      }

      // Load comments
      loadComments(bookId);

      // Show book detail section
      changeSection('bookDetail');
    } catch(err){
      alert('Failed to load book details: ' + err.message);
    }
  }

  // Search functionality
  searchInput.addEventListener('input', async () => {
    const query = searchInput.value.trim().toLowerCase();
    if(query.length < 2){
      searchResults.classList.add('hidden');
      searchResults.innerHTML = '';
      return;
    }
    try {
      const snap = await db.ref('books').once('value');
      const books = snap.val() || {};
      const matches = [];

      for(const [id, book] of Object.entries(books)){
        if(book.title.toLowerCase().includes(query)){
          matches.push({id, title: book.title});
        }
      }

      if(matches.length === 0){
        searchResults.innerHTML = '<p class="p-2 text-gray-600">No matching books found.</p>';
      } else {
        searchResults.innerHTML = '';
        for(const book of matches){
          const div = document.createElement('div');
          div.className = 'p-2 cursor-pointer hover:bg-gray-200';
          div.textContent = book.title;
          div.addEventListener('click', () => {
            searchResults.classList.add('hidden');
            searchInput.value = '';
            openBookDetail(book.id);
          });
          searchResults.appendChild(div);
        }
      }
      searchResults.classList.remove('hidden');
    } catch(err){
      searchResults.innerHTML = `<p class="p-2 text-red-600">Search error: ${err.message}</p>`;
      searchResults.classList.remove('hidden');
    }
  });

  // Hide search results when clicking outside
  // Hide search results when clicking outside
  document.addEventListener('click', e => {
    if(!searchResults.contains(e.target) && e.target !== searchInput){
      searchResults.classList.add('hidden');
    }
  });

  // Auth state observer
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user && user.emailVerified){
      authSection.classList.add('hidden');
      appSection.classList.remove('hidden');

      // Show owner controls if owner logged in
      if(user.email === OWNER_EMAIL){
        ownerControls.classList.remove('hidden');
      } else {
        ownerControls.classList.add('hidden');
      }

      // Default show home
      navButtons.forEach(b => b.classList.remove('border-blue-600', 'text-blue-600'));
      navButtons[0].classList.add('border-blue-600', 'text-blue-600');
      changeSection('home');
    } else {
      authSection.classList.remove('hidden');
      appSection.classList.add('hidden');
    }
  });
</script>

</body>
</html>
