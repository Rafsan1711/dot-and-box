<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dot and Box Online Multiplayer</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  .dot {
    width: 14px;
    height: 14px;
    background-color: white;
    border-radius: 50%;
  }
  .line {
    background-color: #444;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  .line.horizontal {
    height: 7px;
    width: 65px;
  }
  .line.vertical {
    height: 65px;
    width: 7px;
  }
  .line.active {
    cursor: default;
  }
  .box {
    width: 65px;
    height: 65px;
    background-color: #2a2a2a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.6rem;
    color: white;
    user-select: none;
    transition: background-color 0.4s ease;
  }
  .player-1 {
    background-color: #4a90e2;
  }
  .player-2 {
    background-color: #e94e77;
  }
  .player-3 {
    background-color: #f5a623;
  }
  .player-4 {
    background-color: #7ed321;
  }
  #status {
    font-size: 1.7rem;
    font-weight: 700;
    margin: 1rem 0;
    text-align: center;
    padding: 0.7rem 1.4rem;
    border-radius: 8px;
  }
  .blue-turn {
    background-color: #4a90e2;
    box-shadow: 0 0 12px #4a90e2;
  }
  .red-turn {
    background-color: #e94e77;
    box-shadow: 0 0 12px #e94e77;
  }
  .orange-turn {
    background-color: #f5a623;
    box-shadow: 0 0 12px #f5a623;
  }
  .green-turn {
    background-color: #7ed321;
    box-shadow: 0 0 12px #7ed321;
  }
  #winner-message {
    font-size: 1.9rem;
    font-weight: 800;
    text-align: center;
    margin: 1.5rem 0;
    color: #00ff00;
    text-shadow: 0 0 6px #00ff00;
  }
  #restart {
    display: none;
    margin: 0 auto 2rem auto;
    padding: 12px 30px;
    font-size: 1.2rem;
    font-weight: 700;
    background-color: #555;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #restart:hover {
    background-color: #777;
  }
  /* Modal */
  #modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #modal.active {
    display: flex;
  }
  #modal-content {
    background: #111;
    padding: 2rem;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    color: white;
    text-align: center;
  }
  /* Button Active */
  .mode-btn {
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .mode-btn.active {
    background-color: #4ade80; /* green-400 */
    color: black;
  }
  /* Loader */
  .loader {
    border: 5px solid #444;
    border-top: 5px solid #00ff00;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1.5s linear infinite;
    margin: 0 auto 1rem auto;
  }
  @keyframes spin {
    0% {transform: rotate(0deg);}
    100% {transform: rotate(360deg);}
  }
  /* Bottom nav */
  .bottom-nav {
    border-top: 1px solid #555;
    display: flex;
    justify-content: space-around;
    background-color: #121212;
  }
  .bottom-nav button {
    flex-grow: 1;
    padding: 1rem 0;
    font-size: 1.1rem;
    color: #bbb;
    background: none;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .bottom-nav button.active, .bottom-nav button:hover {
    background-color: #222;
    color: white;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

</head>
<body class="min-h-screen flex flex-col">

<!-- Auth Screen -->
<div id="auth-screen" class="flex-grow flex flex-col items-center justify-center p-4">
  <h1 class="text-5xl font-extrabold mb-8">Dot and Box Online</h1>
  <button id="signin-btn" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-semibold shadow" onclick="signIn()">Sign in with Google</button>
</div>

<!-- Main App -->
<div id="app" class="hidden flex-grow flex flex-col">

  <!-- Top Bar -->
  <header class="flex justify-between items-center p-4 border-b border-gray-700">
    <div><span id="username" class="font-bold text-xl"></span> | Rating: <span id="rating" class="font-semibold">0</span></div>
    <button onclick="showScreen('settings')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded font-semibold">Settings</button>
  </header>

  <!-- Screens Container -->
  <main class="flex-grow overflow-auto p-4">
    <!-- Home Screen -->
    <section id="screen-home" class="space-y-6">
      <div class="flex justify-center space-x-4 mb-6">
        <button id="mode-2" class="mode-btn px-5 py-2 border border-white rounded" onclick="selectMode(2)">2 Players</button>
        <button id="mode-3" class="mode-btn px-5 py-2 border border-white rounded" onclick="selectMode(3)">3 Players</button>
        <button id="mode-4" class="mode-btn px-5 py-2 border border-white rounded" onclick="selectMode(4)">4 Players</button>
      </div>
      <div class="flex justify-center mb-6">
        <button id="start-btn" class="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-semibold" onclick="startMatch()">Start Online Game</button>
      </div>

      <div id="match-link" class="text-center mb-6 text-sm text-blue-400"></div>

      <div id="status" class="blue-turn"></div>

      <div id="game-board" class="mx-auto grid gap-1" style="user-select:none;"></div>

      <button id="restart" onclick="restartGame()">Restart Game</button>

      <div id="winner-message"></div>
    </section>

    <!-- Leaderboard Screen -->
    <section id="screen-leaderboard" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Leaderboard</h2>
      <div id="leaderboard-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
    </section>

    <!-- Friends Screen -->
    <section id="screen-friends" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Friends (Coming Soon)</h2>
      <p>Here you will be able to add and play with friends.</p>
    </section>

    <!-- Settings Screen -->
    <section id="screen-settings" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Settings</h2>
      <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold">Sign Out</button>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button id="nav-home" onclick="showScreen('home')" class="active">üè†<br><small>Home</small></button>
    <button id="nav-leaderboard" onclick="showScreen('leaderboard')">‚≠ê<br><small>Leaderboard</small></button>
    <button id="nav-friends" onclick="showScreen('friends')">üë•<br><small>Friends</small></button>
    <button id="nav-settings" onclick="showScreen('settings')">‚öôÔ∏è<br><small>Settings</small></button>
  </nav>
</div>

<!-- Waiting Modal -->
<div id="modal">
  <div id="modal-content">
    <h2 class="text-2xl mb-4">Waiting for other players...</h2>
    <div class="loader"></div>
    <p id="players-found" class="mb-4 font-semibold text-lg">Players found: 1/<span id="total-players">2</span></p>
    <h3 class="mt-2 text-xl font-bold">Current Leaderboard</h3>
    <div id="modal-leaderboard" class="max-h-48 overflow-y-auto text-left text-sm"></div>
  </div>
</div>

<script>
  // Firebase config - ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ credentials ‡¶¨‡¶∏‡¶æ‡¶ì ‡¶è‡¶ñ‡¶æ‡¶®‡ßá
  const firebaseConfig = {
  apiKey: "AIzaSyB-5CakD79CthsI-_vcqblOCN1sXS6U8u8",
  authDomain: "dot-and-box-90d27.firebaseapp.com",
  projectId: "dot-and-box-90d27",
  storageBucket: "dot-and-box-90d27.firebasestorage.app",
  messagingSenderId: "913945926983",
  appId: "1:913945926983:web:b4c00c2cffff5b6fa7c062"
};
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  // UI Elements
  const authScreen = document.getElementById('auth-screen');
  const app = document.getElementById('app');
  const usernameEl = document.getElementById('username');
  const ratingEl = document.getElementById('rating');
  const modeButtons = [2,3,4].map(n => document.getElementById(`mode-${n}`));
  const startBtn = document.getElementById('start-btn');
  const matchLinkEl = document.getElementById('match-link');
  const statusEl = document.getElementById('status');
  const gameBoard = document.getElementById('game-board');
  const restartBtn = document.getElementById('restart');
  const winnerMessage = document.getElementById('winner-message');
  const modal = document.getElementById('modal');
  const modalLeaderboard = document.getElementById('modal-leaderboard');
  const playersFoundEl = document.getElementById('players-found');
  const totalPlayersEl = document.getElementById('total-players');

  // Screens & Nav buttons
  const screens = ['home','leaderboard','friends','settings'].map(name => document.getElementById(`screen-${name}`));
  const navButtons = ['nav-home','nav-leaderboard','nav-friends','nav-settings'].map(id => document.getElementById(id));

  // Game vars
  let user = null;
  let userRating = 1000;
  let mode = 2;
  let matchId = null;
  let players = [];
  let currentPlayerIndex = 0;
  let scores = {};
  let lines = new Set();
  let boardSize = 5; // 5 dots in row/col
  let isMyTurn = false;
  let colors = ['#4a90e2','#e94e77','#f5a623','#7ed321']; // Players colors

  // Show/Hide screens and nav button active states
  function showScreen(name){
    screens.forEach(s => s.classList.add('hidden'));
    navButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`screen-${name}`).classList.remove('hidden');
    document.getElementById(`nav-${name}`).classList.add('active');
  }

  // Authentication
  auth.onAuthStateChanged(async (u) => {
    if(u){
      user = u;
      authScreen.style.display = 'none';
      app.style.display = 'flex';
      usernameEl.textContent = u.displayName;

      const userRef = db.ref(`users/${u.uid}`);
      const snapshot = await userRef.get();
      if(snapshot.exists()){
        userRating = snapshot.val().rating || 1000;
      } else {
        await userRef.set({displayName: u.displayName, rating: 1000});
      }
      ratingEl.textContent = userRating;

      selectMode(2);
      loadLeaderboard();
      showScreen('home');
    } else {
      user = null;
      authScreen.style.display = 'flex';
      app.style.display = 'none';
    }
  });

  function signIn(){
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }
  function signOut(){
    auth.signOut();
  }

  function selectMode(n){
    mode = n;
    modeButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`mode-${n}`).classList.add('active');
    totalPlayersEl.textContent = n;
  }

  // Load leaderboard for modal and leaderboard screen
  async function loadLeaderboard(){
    const snapshot = await db.ref('users').orderByChild('rating').limitToLast(20).get();
    const users = [];
    snapshot.forEach(child => users.push(child.val()));
    users.sort((a,b)=>b.rating - a.rating);

    // Clear both
    modalLeaderboard.innerHTML = '';
    const leaderboardList = document.getElementById('leaderboard-list');
    leaderboardList.innerHTML = '';

    users.forEach((u,i) => {
      const entry = document.createElement('div');
      entry.className = "mb-1";
      entry.textContent = `#${i+1} ${u.displayName} ‚Äî Rating: ${u.rating}`;
      modalLeaderboard.appendChild(entry);

      // Also for main leaderboard
      const e2 = entry.cloneNode(true);
      leaderboardList.appendChild(e2);
    });
  }

  // Start matchmaking with automatic matching for players in same mode
  async function startMatch(){
    modal.classList.add('active');
    players = [];
    currentPlayerIndex = 0;
    scores = {};
    lines.clear();
    winnerMessage.textContent = '';
    restartBtn.style.display = 'none';
    gameBoard.innerHTML = '';
    matchLinkEl.textContent = '';

    totalPlayersEl.textContent = mode;
    updatePlayersFoundUI(1);

    // Look for open match slots of this mode
    const matchesRef = db.ref('matchSlots');
    const matchesSnap = await matchesRef.orderByChild('mode').equalTo(mode).get();

    let joinedMatch = null;
    matchesSnap.forEach(snap => {
      const val = snap.val();
      if(val.players && Object.keys(val.players).length < mode){
        joinedMatch = snap.key;
        return true; // break loop
      }
    });

    if(joinedMatch){
      // Join this match
      const matchRef = db.ref(`matchSlots/${joinedMatch}/players`);
      const playersSnap = await matchRef.get();
      if(playersSnap.exists()){
        const currentPlayers = playersSnap.val();
        if(!currentPlayers[user.uid]){
          currentPlayers[user.uid] = {name: user.displayName};
          await matchRef.set(currentPlayers);
        }
        players = Object.keys(currentPlayers);
        matchId = joinedMatch;
      }
    } else {
      // Create new match slot
      const newMatchRef = matchesRef.push();
      matchId = newMatchRef.key;
      await newMatchRef.set({mode, players: {[user.uid]: {name: user.displayName}}});
      players = [user.uid];
    }

    updatePlayersFoundUI(players.length);

    // Listen for changes
    const currentMatchRef = db.ref(`matchSlots/${matchId}`);
    currentMatchRef.on('value', async snap => {
      const val = snap.val();
      if(!val) return;
      players = val.players ? Object.keys(val.players) : [];
      updatePlayersFoundUI(players.length);

      if(players.length === mode){
        // Start game
        currentMatchRef.off();
        await db.ref(`matches/${matchId}`).set({
          players,
          mode,
          started: true
        });
        await db.ref(`matchSlots/${matchId}`).remove();

        modal.classList.remove('active');
        initGame();
      }
    });
  }

  // Update the "Players found: X / N" text in modal
  function updatePlayersFoundUI(currentCount){
    playersFoundEl.innerHTML = `Players found: ${currentCount}/${mode}`;
  }

  // Initialize the game board and variables
  function initGame(){
    isMyTurn = (players[currentPlayerIndex] === user.uid);
    lines.clear();
    scores = {};
    winnerMessage.textContent = '';
    restartBtn.style.display = 'none';
    matchLinkEl.textContent = '';

    // Setup scores for each player
    players.forEach((p, idx) => {
      scores[p] = 0;
    });

    createBoard();
    updateStatus();
  }

  // Create the Dot and Box board UI grid
  function createBoard(){
    // Clear previous board
    gameBoard.innerHTML = '';

    // Board size is dots count per row/col, so boxes are (boardSize-1)^2
    // Grid structure: alternating dot-line-dot-line ... (2*boardSize-1 rows and cols)
    const gridSize = 2 * boardSize - 1;
    gameBoard.style.gridTemplateColumns = `repeat(${gridSize}, auto)`;
    gameBoard.style.gridTemplateRows = `repeat(${gridSize}, auto)`;

    for(let row=0; row<gridSize; row++){
      for(let col=0; col<gridSize; col++){
        if(row % 2 === 0 && col % 2 === 0){
          // Dot
          const dot = document.createElement('div');
          dot.className = 'dot';
          gameBoard.appendChild(dot);
        } else if(row % 2 === 0){
          // Horizontal line
          const line = document.createElement('div');
          line.className = 'line horizontal';
          line.dataset.type = 'h';
          line.dataset.row = row;
          line.dataset.col = col;
          line.onclick = () => handleLineClick(line);
          gameBoard.appendChild(line);
        } else if(col % 2 === 0){
          // Vertical line
          const line = document.createElement('div');
          line.className = 'line vertical';
          line.dataset.type = 'v';
          line.dataset.row = row;
          line.dataset.col = col;
          line.onclick = () => handleLineClick(line);
          gameBoard.appendChild(line);
        } else {
          // Box
          const box = document.createElement('div');
          box.className = 'box';
          box.dataset.row = row;
          box.dataset.col = col;
          gameBoard.appendChild(box);
        }
      }
    }
  }

  // Handle clicking on a line
  function handleLineClick(line){
    if(!isMyTurn) return; // Only current player can play

    if(line.classList.contains('active')) return; // Already taken

    const lineId = `${line.dataset.type}${line.dataset.row}-${line.dataset.col}`;
    if(lines.has(lineId)) return; // Defensive

    // Mark line as active and record it
    line.classList.add('active');
    line.style.backgroundColor = colors[currentPlayerIndex];
    lines.add(lineId);

    // Check if this move completes any boxes
    const completedBoxes = checkCompletedBoxes(line.dataset.type, parseInt(line.dataset.row), parseInt(line.dataset.col));
    if(completedBoxes.length > 0){
      // Mark boxes with current player color and increment score
      completedBoxes.forEach(box => {
        box.element.classList.add(`player-${currentPlayerIndex+1}`);
        scores[players[currentPlayerIndex]]++;
      });
      updateStatus();
      // Player gets another turn - do not change currentPlayerIndex
    } else {
      // No boxes completed - next player's turn
      currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
      isMyTurn = (players[currentPlayerIndex] === user.uid);
      updateStatus();
    }

    // Check if game ended
    if(lines.size === ((boardSize-1) * boardSize * 2)){ // total lines count: horizontal + vertical lines
      endGame();
    }
  }

  // Check which boxes got completed by last line placed
  function checkCompletedBoxes(type, row, col){
    const completed = [];
    // Boxes are on odd row and col positions
    // Check up to 2 boxes that this line may complete

    function getLineId(t,r,c){
      return `${t}${r}-${c}`;
    }

    // Helper to get box element by row,col
    function getBox(r,c){
      if(r < 0 || c < 0) return null;
      const gridSize = 2*boardSize - 1;
      if(r >= gridSize || c >= gridSize) return null;
      // Box elements are divs with class "box" in gameBoard children
      // Because the board is a grid, we can find the index:
      // index = r*gridSize + c
      const idx = r * gridSize + c;
      const el = gameBoard.children[idx];
      if(el && el.classList.contains('box')) return el;
      return null;
    }

    const gridSize = 2*boardSize - 1;

    if(type === 'h'){
      // Horizontal line at (row, col) is above box at (row+1,col) and below box at (row-1,col)
      // Check box below
      const boxBelow = getBox(row+1, col);
      if(boxBelow){
        // Check all 4 lines of this box:
        // Top horizontal: h(row, col)
        // Bottom horizontal: h(row+2, col)
        // Left vertical: v(row+1, col-1)
        // Right vertical: v(row+1, col+1)
        const top = getLineId('h', row, col);
        const bottom = getLineId('h', row+2, col);
        const left = getLineId('v', row+1, col-1);
        const right = getLineId('v', row+1, col+1);
        if(lines.has(top) && lines.has(bottom) && lines.has(left) && lines.has(right)){
          completed.push({element: boxBelow});
        }
      }
      // Check box above
      const boxAbove = getBox(row-1, col);
      if(boxAbove){
        const top = getLineId('h', row-2, col);
        const bottom = getLineId('h', row, col);
        const left = getLineId('v', row-1, col-1);
        const right = getLineId('v', row-1, col+1);
        if(lines.has(top) && lines.has(bottom) && lines.has(left) && lines.has(right)){
          completed.push({element: boxAbove});
        }
      }
    } else if(type === 'v'){
      // Vertical line at (row, col) is left of box at (row, col+1) and right of box at (row, col-1)
      // Check box right
      const boxRight = getBox(row, col+1);
      if(boxRight){
        const top = getLineId('h', row-1, col+1);
        const bottom = getLineId('h', row+1, col+1);
        const left = getLineId('v', row, col);
        const right = getLineId('v', row, col+2);
        if(lines.has(top) && lines.has(bottom) && lines.has(left) && lines.has(right)){
          completed.push({element: boxRight});
        }
      }
      // Check box left
      const boxLeft = getBox(row, col-1);
      if(boxLeft){
        const top = getLineId('h', row-1, col-1);
        const bottom = getLineId('h', row+1, col-1);
        const left = getLineId('v', row, col-2);
        const right = getLineId('v', row, col);
        if(lines.has(top) && lines.has(bottom) && lines.has(left) && lines.has(right)){
          completed.push({element: boxLeft});
        }
      }
    }
    return completed;
  }

  // Update status bar showing current player turn and scores
  function updateStatus(){
    const playerName = players[currentPlayerIndex] === user.uid ? "Your turn" : `Player ${currentPlayerIndex+1}'s turn`;
    statusEl.textContent = playerName;

    // Update status color
    const colorsClass = ['blue-turn', 'red-turn', 'orange-turn', 'green-turn'];
    statusEl.className = colorsClass[currentPlayerIndex];

    // Optionally show scores in status
    let scoreText = 'Scores: ';
    players.forEach((p,i) => {
      const n = p === user.uid ? "You" : `P${i+1}`;
      scoreText += `${n}: ${scores[p]} `;
    });
    statusEl.textContent = `${playerName} | ${scoreText.trim()}`;
  }

  // End the game and show winner
  function endGame(){
    restartBtn.style.display = 'block';
    isMyTurn = false;

    // Find max score
    let maxScore = -1;
    players.forEach(p => {
      if(scores[p] > maxScore) maxScore = scores[p];
    });
    // Find all winners (tie possible)
    const winners = players.filter(p => scores[p] === maxScore);

    if(winners.length === 1){
      const winnerIndex = players.indexOf(winners[0]);
      winnerMessage.textContent = (winners[0] === user.uid) ? "You won! üéâ" : `Player ${winnerIndex+1} won! üéâ`;
    } else {
      winnerMessage.textContent = "It's a tie!";
    }
  }

  // Restart the current game (local)
  function restartGame(){
    lines.clear();
    scores = {};
    winnerMessage.textContent = '';
    restartBtn.style.display = 'none';
    currentPlayerIndex = 0;
    isMyTurn = (players[currentPlayerIndex] === user.uid);
    createBoard();
    updateStatus();
  }

</script>
</body>
</html>

  
