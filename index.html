<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Dot & Box Online Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#121212; color:#fff; display:flex; flex-direction:column; min-height:100vh; }
    #auth-screen, #app { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    #app { padding:1rem; }
    .hidden { display:none !important; }
    header{width:100%; display:flex; justify-content:space-between; align-items:center; padding:0.5rem; background:#1f1f1f;}
    header .mode-buttons button, header .signout{margin:0 0.25rem;}
    #match-link{font-size:0.875rem; color:#4aa0ff;}
    #game-board{display:grid; gap:4px; margin:1rem auto; touch-action:none;}
    .dot{width:8px;height:8px;background:#fff;border-radius:50%;}
    .line{background:#444;cursor:pointer;transition:background 0.2s;}
    .horizontal{height:4px;}
    .vertical{width:4px;}
    .active{cursor:default;}
    .box{background:#2a2a2a; display:flex;align-items:center;justify-content:center;font-weight:bold;}
    .player-1{background:#4a90e2;}
    .player-2{background:#e94e77;}
    .player-3{background:#f5a623;}
    .player-4{background:#7ed321;}
    #player-list{display:flex;justify-content:center;flex-wrap:wrap;gap:1rem; margin-top:1rem;}
    .player-item{display:flex;align-items:center; gap:0.5rem;}
    .player-circle{width:16px;height:16px;border-radius:50%;transition:transform 0.3s,box-shadow 0.3s;}
    .turn{transform:scale(1.4);box-shadow:0 0 8px currentColor;}
    #status{margin-top:1rem;font-size:1.1rem;min-height:1.2em; text-align:center;}
    #winner{margin-top:1rem;font-size:1.2rem;color:#4caf50;}
    button{background:#333;color:#fff;border:none;padding:0.5rem 1rem;border-radius:0.25rem;}
    button:hover{background:#555;}
    footer{margin-top:auto;padding:0.5rem;text-align:center;background:#1f1f1f;}
    /* Responsive board */
    @media(min-width:640px){#game-board{width:calc(4*13px + var(--box-size)*var(--boxes)) !important;}}
  </style>
</head>
<body>
  <div id="auth-screen">
    <h1 class="text-2xl mb-4">Dot & Box Online</h1>
    <button onclick="signIn()">Sign in with Google</button>
  </div>
  <div id="app" class="hidden">
    <header>
      <div id="user-info"><span id="username"></span> <span id="rating"></span></div>
      <div class="mode-buttons">
        <button id="btn2" onclick="selectMode(2)">2 Players</button>
        <button id="btn4" onclick="selectMode(4)">4 Players</button>
        <button id="btnBot" onclick="playWithBot()">Bot Mode</button>
      </div>
      <button class="signout" onclick="signOut()">Sign Out</button>
    </header>
    <div id="match-link"></div>
    <div id="player-list"></div>
    <div id="status"></div>
    <div id="game-board"></div>
    <div id="winner"></div>
    <button id="btnRestart" class="hidden" onclick="restart()">Restart</button>
  </div>
  <footer>Leaderboard<div id="leaderboard"></div></footer>
<script>
  const firebaseConfig={apiKey:"AIzaSyCKfr-jvUKonc2TcEDcejk562kOm8LTAa0",authDomain:"dot-and-box-online.firebaseapp.com",databaseURL:"https://dot-and-box-online-default-rtdb.firebaseio.com/",projectId:"dot-and-box-online",storageBucket:"dot-and-box-online.appspot.com",messagingSenderId:"334340725862",appId:"1:334340725862:web:356b78d59e76ff6f5861a7"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(),db=firebase.database();
  let user,mode=2,code,players=[],turn=0,boxes=8;let lines=new Set(),scores={},bots=[];
  const authScreen=document.getElementById('auth-screen'),app=document.getElementById('app');
  const usernameEl=document.getElementById('username'),ratingEl=document.getElementById('rating');
  const matchLink=document.getElementById('match-link'),playerList=document.getElementById('player-list');
  const statusEl=document.getElementById('status'),winnerEl=document.getElementById('winner');
  const board=document.getElementById('game-board'),leaderboard=document.getElementById('leaderboard');
  auth.onAuthStateChanged(async u=>{if(u){user=u;authScreen.classList.add('hidden');app.classList.remove('hidden');usernameEl.textContent=u.displayName;const ref=db.ref('users/'+u.uid),sn=await ref.get();let r=sn.child('rating').exists()?sn.child('rating').val():50;await ref.update({rating:r,displayName:u.displayName});ratingEl.textContent='Rating:'+r;loadLB();selectMode(2);}else{authScreen.classList.remove('hidden');app.classList.add('hidden');}});
  function signIn(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
  function signOut(){auth.signOut();location.reload();}
  function selectMode(m){mode=m;startMatch();}
  function generateCode(){return(Math.floor(1e7+Math.random()*9e7)).toString();}
  async function startMatch(){lines.clear();scores={};turn=0;bots=[];players=[];code=generateCode();matchLink.textContent='Code:'+code;const slot=db.ref('slots/'+code);const sn=await slot.get();const v=sn.val()||{};if(!v.p1){await slot.update({p1:user.uid});players=[user.uid];waitp(slot);}else if(!v.p2&&mode>=2){await slot.update({p2:user.uid});players=[v.p1,user.uid];if(mode===2)begin();else waitp(slot);}else if(mode===4&&!v.p3){await slot.update({p3:user.uid});waitp(slot);}else if(mode===4&&!v.p4){await slot.update({p4:user.uid});begin();}}
  function waitp(slot){slot.on('value',snap=>{const v=snap.val()||{};players=['p1','p2','p3','p4'].filter(k=>v[k]).map(k=>v[k]);if((mode===2&&players.length===2)||(mode===4&&players.length===4)){slot.off();slot.remove();begin();}});}  
  function playWithBot(){lines.clear();scores={};turn=0;bots=[];players=[user.uid];for(let i=1;i<mode;i++){players.push('bot'+i);bots.push('bot'+i);}begin();}
  function begin(){renderPlayers();renderBoard();updateStatus();document.getElementById('btnRestart').classList.remove('hidden');if(bots.includes(players[turn]))setTimeout(botMove,500);}
  function renderPlayers(){playerList.innerHTML='';players.forEach((p,i)=>{const div=document.createElement('div');div.className='player-item';const clr=['#4a90e2','#e94e77','#f5a623','#7ed321'][i];div.style.color=clr;const circ=document.createElement('div');circ.className='player-circle';circ.style.background=clr;if(i===turn)circ.classList.add('turn');div.append(circ,document.createTextNode(p===user.uid?'You':p.startsWith('bot')?'Bot'+i:'P'+(i+1)));playerList.append(div);});}
  function renderBoard(){const sz=boxes*2-1;board.style.setProperty('--boxes',boxes);board.style.gridTemplateColumns=`repeat(${sz},auto)`;board.innerHTML='';for(let r=0;r<sz;r++)for(let c=0;c<sz;c++){if(r%2===0&&c%2===0){const d=document.createElement('div');d.className='dot';board.append(d);}else if(r%2===0||c%2===0){const l=document.createElement('div');l.className='line '+(r%2===0?'horizontal':'vertical');l.dataset.key=`${r}_${c}`;l.onclick=()=>pick(r,c);board.append(l);}else{const b=document.createElement('div');b.className='box';b.dataset.key=`${r}_${c}`;b.style.width=b.style.height='calc((100vw - 2rem)/'+boxes+')';board.append(b);}}}
  function pick(r,c){const key=`${r}_${c}`;if(lines.has(key)||!isGame){return;}lines.add(key);const el=document.querySelector(`.line[data-key='${key}']`);el.classList.add('active');el.style.background=['#4a90e2','#e94e77','#f5a623','#7ed321'][turn];if(!claim(r,c))turn=(turn+1)%players.length;updateStatus();if(bots.includes(players[turn]))setTimeout(botMove,300);}
  function claim(r,c){let ok=false;[[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc])=>{const rr=r+dr,cc=c+dc;const need=[[rr-1,cc],[rr+1,cc],[rr,cc-1],[rr,cc+1]];if(rr%2&&cc%2&&need.every(([x,y])=>lines.has(`${x}_${y}`))){const b=document.querySelector(`.box[data-key='${rr}_${cc}']`);if(!b.classList.length){b.classList.add('player-'+(turn+1));b.textContent=turn+1;scores[players[turn]]=(scores[players[turn]]||0)+1;ok=true;}}});return ok;}
  function updateStatus(){isGame=true;const s=`P${turn+1}'s Turn`;statusEl.textContent=s;renderPlayers();checkEnd();}
  function botMove(){const avail=Array.from(document.querySelectorAll('.line')).filter(x=>!lines.has(x.dataset.key));const pick=avail[Math.floor(Math.random()*avail.length)];const [r,c]=pick.dataset.key.split('_').map(Number);pick(r,c);}  
  function checkEnd(){const total=boxes*boxes;const done=Object.values(scores).reduce((a,b)=>a+(b||0),0);if(done>=total){isGame=false;const win=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0][0];winnerEl.textContent=`Winner: ${win}`;document.getElementById('btnRestart').classList.remove('hidden');}}
  function restart(){lines.clear();scores={};turn=0;winnerEl.textContent='';renderBoard();updateStatus();}
  async function loadLB(){const sn=await db.ref('users').orderByChild('rating').limitToLast(10).get();const arr=[];sn.forEach(c=>arr.push(c.val().displayName+':'+c.val().rating));leaderboard.innerHTML=arr.map(x=>`<div>${x}</div>`).join('');}
</script>
</body>
</html>
