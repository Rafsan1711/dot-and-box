<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dots and Boxes Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } 
    .dot { width: 12px; height: 12px; background: white; border-radius: 50%; }
    .edge { cursor: pointer; }
    .edge.selected-0 { background: red; }
    .edge.selected-1 { background: blue; }
    .edge.selected-2 { background: green; }
    .edge.selected-3 { background: yellow; }
    .box.filled-0::after { content: '0'; }
    .box.filled-1::after { content: '1'; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Auth Screen -->
<div id="auth-screen" class="flex-grow flex flex-col items-center justify-center">
  <h1 class="text-5xl font-extrabold mb-8 tracking-tight">Dots and Boxes Online</h1>
  <button onclick="signIn()" class="bg-blue-600 hover:bg-blue-700 transition px-8 py-3 rounded-lg font-semibold shadow">
    Sign in with Google
  </button>
</div>

<!-- Main App -->
<div id="app" class="hidden flex-grow flex flex-col">
  <!-- Top Bar -->
  <div class="p-4 flex justify-between items-center border-b border-gray-700">
    <div>
      <span id="username" class="font-semibold"></span>
      <span class="text-gray-400 ml-2">Rating: <span id="rating">0</span></span>
    </div>
    <div id="match-link" class="text-sm text-blue-400"></div>
  </div>

  <!-- Screens Container -->
  <div id="screens" class="flex-grow overflow-auto p-4">
    <!-- Home Screen -->
    <div id="screen-home" class="space-y-6">
      <div class="flex space-x-4">
        <button onclick="startMatching(2)" class="flex-1 bg-green-600 hover:bg-green-700 transition px-6 py-3 rounded-lg font-semibold shadow">2 Players</button>
        <button onclick="startMatching(4)" class="flex-1 bg-purple-600 hover:bg-purple-700 transition px-6 py-3 rounded-lg font-semibold shadow">4 Players</button>
      </div>

      <!-- Waiting Modal -->
      <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center space-y-4 max-w-md w-full">
          <p class="text-lg font-semibold">Waiting for players...</p>
          <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-white mx-auto"></div>
          <h3 class="mt-4 text-xl font-bold">Current Leaderboard</h3>
          <div id="modal-leaderboard" class="space-y-2 max-h-48 overflow-auto"></div>
        </div>
      </div>

      <!-- Game Board -->
      <div id="board-container" class="mx-auto hidden"></div>
      <!-- Scores & Status -->
      <div id="status" class="mt-4 text-center"></div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="screen-leaderboard" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Leaderboard</h2>
      <div id="leaderboard-list" class="space-y-3"></div>
    </div>

    <!-- Settings Screen -->
    <div id="screen-settings" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Settings</h2>
      <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 transition px-6 py-3 rounded-lg font-semibold shadow">
        Sign Out
      </button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="border-t border-gray-700 flex justify-around p-2">
    <button onclick="showScreen('home')" class="flex-grow text-center py-2 hover:bg-gray-800 rounded transition">üè†<br><span class="text-sm">Home</span></button>
    <button onclick="showScreen('leaderboard')" class="flex-grow text-center py-2 hover:bg-gray-800 rounded transition">‚≠ê<br><span class="text-sm">Leaderboard</span></button>
    <button onclick="showScreen('settings')" class="flex-grow text-center py-2 hover:bg-gray-800 rounded transition">‚öôÔ∏è<br><span class="text-sm">Settings</span></button>
  </div>
</div>

<script>
  // Firebase Config (unchanged)
  
     const firebaseConfig = {
  apiKey: "AIzaSyB-5CakD79CthsI-_vcqblOCN1sXS6U8u8",
  authDomain: "dot-and-box-90d27.firebaseapp.com",
  databaseURL: "https://dot-and-box-90d27-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dot-and-box-90d27",
  storageBucket: "dot-and-box-90d27.firebasestorage.app",
  messagingSenderId: "913945926983",
  appId: "1:913945926983:web:b4c00c2cffff5b6fa7c062"

   };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // UI refs
  const authScreen = document.getElementById('auth-screen');
  const app = document.getElementById('app');
  const usernameEl = document.getElementById('username');
  const ratingEl = document.getElementById('rating');
  const boardContainer = document.getElementById('board-container');
  const statusEl = document.getElementById('status');
  const modal = document.getElementById('modal');
  const matchLinkEl = document.getElementById('match-link');
  
  let user, gameId, playerCount, players = [], currentIdx = 0;
  let size = 4; // 4x4 boxes
  let edges = {}; // key: "h-x-y" or "v-x-y"
  let boxes = {};
  let scores = [];

  auth.onAuthStateChanged(async u => {
    if(u){ user=u; authScreen.classList.add('hidden'); app.classList.remove('hidden'); usernameEl.textContent = u.displayName;
      const uref = db.ref('users/'+u.uid);
      const snap = await uref.get(); let r = snap.child('rating').exists()?snap.child('rating').val():1000;
      await uref.update({rating:r, displayName:u.displayName}); ratingEl.textContent = r;
      loadLeaderboard(); showScreen('home');
      const code = new URLSearchParams(window.location.search).get('match'); if(code) matchLinkEl.innerHTML=`Link: <code>?match=${code}</code>`;
    }
  });

  function signIn(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  function signOut(){ auth.signOut(); location.reload(); }
  function showScreen(n){ ['home','leaderboard','settings'].forEach(s=>document.getElementById('screen-'+s).classList.add('hidden')); document.getElementById('screen-'+n).classList.remove('hidden'); }

  async function loadLeaderboard(){ const snap=await db.ref('users').orderByChild('rating').limitToLast(20).get(); let list=[]; snap.forEach(c=>list.push({name:c.val().displayName,rating:c.val().rating})); list.sort((a,b)=>b.rating-a.rating);
    document.getElementById('leaderboard-list').innerHTML=''; document.getElementById('modal-leaderboard').innerHTML='';
    list.forEach((u,i)=>{ const e=document.createElement('div'); e.className='flex justify-between p-3 bg-gray-700 rounded-lg'; e.innerHTML=`<span>#${i+1}</span><span>${u.name}</span><span>${u.rating}</span>`; document.getElementById('leaderboard-list').appendChild(e); document.getElementById('modal-leaderboard').appendChild(e.cloneNode(true)); }); }

  async function startMatching(n){ playerCount=n; let code=new URLSearchParams(window.location.search).get('match'); if(!code){ code=Math.floor(1e7+Math.random()*9e7).toString(); history.replaceState(null,'','?match='+code); }
    matchLinkEl.innerHTML=`Link: <code>?match=${code}</code>`; modal.classList.remove('hidden');
    const slotRef=db.ref('matchSlots/'+code);
    const snap=await slotRef.get();
    if(!snap.exists()){ await slotRef.set({playerCount:n, players:[user.uid]});
      slotRef.on('value', s=>checkSlot(s));
    } else if(snap.val().playerCount===n && snap.val().players.indexOf(user.uid)===-1){ let arr=snap.val().players; arr.push(user.uid); await slotRef.update({players:arr}); checkSlot({val:()=>snap.val()}); slotRef.remove(); }
  }
  function checkSlot(snap){ const d=snap.val(); if(d.players.length===playerCount){ players=d.players; initGame(); db.ref('matchSlots/'+gameId).remove(); modal.classList.add('hidden'); }
  }

  function initGame(){ gameId=new URLSearchParams(window.location.search).get('match'); // init state
    players.forEach((p,i)=>scores[i]=0);
    resetBoard(); db.ref('games/'+gameId).set({edges, boxes, currentIdx,scores}); listenGame(); render(); }

  function resetBoard(){ edges={}; boxes={}; for(let x=0;x< size;x++){ for(let y=0;y<=size;y++){ edges[`h-${x}-${y}`]=null; } for(let y=0;y< size;y++){ edges[`v-${y}-${x}`]=null; boxes[`b-${y}-${x}`]=null; } } }

  function listenGame(){ db.ref('games/'+gameId).on('value',snap=>{ const d=snap.val(); if(!d) return; edges=d.edges; boxes=d.boxes; currentIdx=d.currentIdx; scores=d.scores; render(); if(Object.values(edges).every(e=>e!==null)){ endGame(); } }); }

  async function selectEdge(key){ if(edges[key]!==null|| players[currentIdx]!==user.uid) return; edges[key]=currentIdx; let boxCompleted=false;
    const [t,x,y]=key.split('-'); if(t==='h'){ if(y>0 && checkBox(x,y-1)) boxCompleted=true; if(y<size && checkBox(x,y)) boxCompleted=true; } else { if(x>0 && checkBox(x-1,y)) boxCompleted=true; if(x<size && checkBox(x,y)) boxCompleted=true; }
    if(boxCompleted){ scores[currentIdx]++; } else { currentIdx=(currentIdx+1)%playerCount; }
    await db.ref('games/'+gameId).update({edges,boxes,currentIdx,scores}); }

  function checkBox(x,y){ let filled=true; const id=`b-${x}-${y}`; if(boxes[id]!==null) return false;
    if(edges[`h-${x}-${y}`]===null) filled=false;
    if(edges[`h-${x}-${y+1}`]===null) filled=false;
    if(edges[`v-${x}-${y}`]===null) filled=false;
    if(edges[`v-${x+1}-${y}`]===null) filled=false;
    if(filled) boxes[id]=currentIdx;
    return filled; }

  function render(){ boardContainer.innerHTML=''; boardContainer.classList.remove('hidden'); // grid dims
    boardContainer.style.display='grid'; boardContainer.style.gridTemplateRows=`repeat(${size*2+1}, auto)`; boardContainer.style.gridTemplateColumns=`repeat(${size*2+1}, auto)`;
    for(let r=0;r< size*2+1;r++){ for(let c=0;c< size*2+1;c++){ const div=document.createElement('div'); if(r%2===0 && c%2===0){ div.className='dot'; }
        else if(r%2===0){ const x=r/2, y=(c-1)/2; const key=`h-${x}-${y}`; div.className=`edge w-16 h-2 ${edges[key]!==null?`selected-${edges[key]}`:'bg-gray-700 hover:bg-gray-600'}`;
          div.onclick=()=>selectEdge(key);
        }
        else if(c%2===0){ const x=(r-1)/2, y=c/2; const key=`v-${x}-${y}`; div.className=`edge w-2 h-16 ${edges[key]!==null?`selected-${edges[key]}`:'bg-gray-700 hover:bg-gray-600'}`;
          div.onclick=()=>selectEdge(key);
        }
        else { const x=(r-1)/2, y=(c-1)/2, id=`b-${x}-${y}`; div.className=`box w-16 h-16 flex items-center justify-center ${boxes[id]!==null?`bg-gray-600 filled-${boxes[id]}`:'bg-gray-800'}`;
          if(boxes[id]!==null) div.textContent = boxes[id]+1;
        }
        boardContainer.appendChild(div);
      } }
    statusEl.textContent = `Scores: ${scores.map((s,i)=>`P${i+1}: ${s}`).join(' | ')} | Turn: P${currentIdx+1}`;
  }

  async function endGame(){ db.ref('games/'+gameId).off(); let max=Math.max(...scores), winners=[]; scores.forEach((v,i)=>{ if(v===max) winners.push(i+1); }); statusEl.textContent = `Game Over! Winner: ${winners.map(i=>`P${i}`).join(', ')}`;
    // update rating of current user
    const snap=await db.ref('users/'+user.uid+'/rating').get(); let r=snap.val(); if(winners.includes(players.indexOf(user.uid)+1)) r+=12; else r-=4;
    await db.ref('users/'+user.uid+'/rating').set(r); ratingEl.textContent = r;
    setTimeout(()=>{ boardContainer.classList.add('hidden'); statusEl.textContent=''; history.replaceState(null,'',' '); },5000);
  }
</script>
</body>
</html>
