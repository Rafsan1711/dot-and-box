<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dot and Box Online Multiplayer with Friends & Notifications</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  /* Friends Screen Search Input */
  #friend-search {
    width: 100%;
    max-width: 480px;
    margin: 0 auto 1rem auto;
    padding: 0.5rem 1rem;
    font-size: 1.1rem;
    border-radius: 12px;
    border: 2px solid #3b82f6;
    background: transparent;
    color: white;
    outline: none;
    box-shadow:
      0 0 8px #3b82f6,
      inset 0 0 6px #3b82f6;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  #friend-search:focus {
    border-color: #60a5fa;
    box-shadow:
      0 0 12px #60a5fa,
      inset 0 0 8px #60a5fa;
  }

  /* Friend / Search Result item */
  .friend-item, .search-item {
    max-width: 480px;
    background: #1e40af33; /* translucent blue */
    margin: 0.4rem auto;
    padding: 0.6rem 1rem;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: default;
    transition: background-color 0.2s ease;
  }
  .friend-item:hover, .search-item:hover {
    background: #1e40af88;
  }

  .friend-photo {
    width: 56px;
    height: 56px;
    border-radius: 9999px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .friend-info {
    flex-grow: 1;
  }
  .friend-name {
    font-size: 1.15rem;
    font-weight: 600;
  }
  .friend-rating {
    font-size: 0.9rem;
    color: #93c5fd; /* light blue */
  }

  /* Add Friend Button */
  .add-friend-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #2563eb; /* blue-600 */
    color: white;
    font-weight: 700;
    font-size: 1.6rem;
    line-height: 36px;
    text-align: center;
    user-select: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .add-friend-btn.added {
    background: #dc2626; /* red-600 */
  }
  .add-friend-btn:hover {
    background-color: #3b82f6;
  }
  .add-friend-btn.added:hover {
    background-color: #b91c1c;
  }

  /* Notification Icon */
  #notification-icon {
    font-size: 1.8rem;
    cursor: pointer;
    position: relative;
  }
  #notification-icon .badge {
    position: absolute;
    top: -6px;
    right: -10px;
    background: #dc2626;
    color: white;
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 9999px;
    font-weight: 700;
  }

  /* Notification Modal */
  #notification-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1100;
  }
  #notification-modal.active {
    display: flex;
  }
  #notification-content {
    background: #111827;
    padding: 1.5rem;
    border-radius: 12px;
    width: 90%;
    max-width: 480px;
    max-height: 80vh;
    overflow-y: auto;
    color: white;
  }
  #notification-content h3 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  .notification-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #1e40af33;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    margin-bottom: 0.6rem;
  }
  .notification-text {
    flex-grow: 1;
  }
  .notification-buttons {
    display: flex;
    gap: 0.5rem;
  }
  .notif-btn {
    cursor: pointer;
    font-size: 1.4rem;
    user-select: none;
    transition: color 0.2s ease;
  }
  .notif-btn.accept {
    color: #22c55e; /* green */
  }
  .notif-btn.accept:hover {
    color: #16a34a;
  }
  .notif-btn.decline {
    color: #ef4444; /* red */
  }
  .notif-btn.decline:hover {
    color: #b91c1c;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

</head>
<body class="min-h-screen flex flex-col">

<!-- Auth Screen -->
<div id="auth-screen" class="flex-grow flex flex-col items-center justify-center p-4">
  <h1 class="text-5xl font-extrabold mb-8">Dot and Box Online</h1>
  <button id="signin-btn" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-semibold shadow" onclick="signIn()">Sign in with Google</button>
</div>

<!-- Main App -->
<div id="app" class="hidden flex-grow flex flex-col">

  <!-- Top Bar -->
  <header class="flex justify-between items-center p-4 border-b border-gray-700">
    <div>
      <span id="username" class="font-bold text-xl"></span> | Rating: <span id="rating" class="font-semibold">0</span>
    </div>
    <div class="flex items-center space-x-6">
      <div id="notification-icon" title="Notifications">üîî<span class="badge" style="display:none">0</span></div>
      <button onclick="showScreen('settings')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded font-semibold">Settings</button>
    </div>
  </header>

  <!-- Screens Container -->
  <main class="flex-grow overflow-auto p-4">

    <!-- Home Screen -->
    <section id="screen-home" class="space-y-6">
      <!-- (your existing home screen content here) -->
      <p>Home Screen Content...</p>
    </section>

    <!-- Leaderboard Screen -->
    <section id="screen-leaderboard" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Leaderboard</h2>
      <div id="leaderboard-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
    </section>

    <!-- Friends Screen -->
    <section id="screen-friends" class="hidden">
      <h2 class="text-3xl font-bold mb-4">Friends</h2>
      <input
        type="text"
        id="friend-search"
        placeholder="Search friends by username..."
        autocomplete="off"
        spellcheck="false"
      />
      <div id="friends-list" class="mb-6">
        <!-- Friends will be rendered here -->
      </div>
      <div id="search-results" class="mb-6">
        <!-- Search results will appear here -->
      </div>
    </section>

    <!-- Settings Screen -->
    <section id="screen-settings" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Settings</h2>
      <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold">Sign Out</button>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button id="nav-home" onclick="showScreen('home')" class="active">üè†<br><small>Home</small></button>
    <button id="nav-leaderboard" onclick="showScreen('leaderboard')">‚≠ê<br><small>Leaderboard</small></button>
    <button id="nav-friends" onclick="showScreen('friends')">üë•<br><small>Friends</small></button>
    <button id="nav-settings" onclick="showScreen('settings')">‚öôÔ∏è<br><small>Settings</small></button>
  </nav>
</div>

<!-- Notification Modal -->
<div id="notification-modal">
  <div id="notification-content">
    <h3>Friend Requests</h3>
    <div id="notification-list">
      <!-- Notifications will be here -->
    </div>
    <button onclick="closeNotificationModal()" class="mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded font-semibold">Close</button>
  </div>
</div>

<script>
  // Firebase config - ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ credentials ‡¶¨‡¶∏‡¶æ‡¶ì ‡¶è‡¶ñ‡¶æ‡¶®‡ßá
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  // UI Elements
  const authScreen = document.getElementById('auth-screen');
  const app = document.getElementById('app');
  const usernameEl = document.getElementById('username');
  const ratingEl = document.getElementById('rating');

  const friendSearchInput = document.getElementById('friend-search');
  const friendsListEl = document.getElementById('friends-list');
  const searchResultsEl = document.getElementById('search-results');

  const notificationIcon = document.getElementById('notification-icon');
  const notificationBadge = notificationIcon.querySelector('.badge');
  const notificationModal = document.getElementById('notification-modal');
  const notificationList = document.getElementById('notification-list');

  // Navigation buttons & screens
  const screens = ['home','leaderboard','friends','settings'].map(name => document.getElementById(`screen-${name}`));
  const navButtons = ['nav-home','nav-leaderboard','nav-friends','nav-settings'].map(id => document.getElementById(id));

  // App state
  let user = null;
  let userRating = 1000;
  let allUsers = []; // all users cached for search
  let friends = {};  // friends map uid:true
  let friendRequests = {}; // incoming friend requests {fromUid: true}

  // Initialize
  auth.onAuthStateChanged(async (u) => {
    if(u){
      user = u;
      authScreen.style.display = 'none';
      app.style.display = 'flex';
      usernameEl.textContent = u.displayName;

      // Load user rating
      const userRef = db.ref(`users/${u.uid}`);
      const snapshot = await userRef.get();
      if(snapshot.exists()){
        userRating = snapshot.val().rating || 1000;
      } else {
        await userRef.set({displayName: u.displayName, rating: 1000, photoURL: u.photoURL});
      }
      ratingEl.textContent = userRating;

      // Load all users once for searching (can be optimized by paging or querying later)
      loadAllUsers();

      // Load friends and friend requests
      listenToFriends();
      listenToFriendRequests();

      showScreen('home');
    } else {
      user = null;
      authScreen.style.display = 'flex';
      app.style.display = 'none';
    }
  });

  function signIn(){
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }
  function signOut(){
    auth.signOut();
  }

  // Show screen & update nav active
  function showScreen(name){
    screens.forEach(s => s.classList.add('hidden'));
    navButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`screen-${name}`).classList.remove('hidden');
    document.getElementById(`nav-${name}`).classList.add('active');
  }

  // Load all users for search
  async function loadAllUsers(){
    const snapshot = await db.ref('users').get();
    allUsers = [];
    snapshot.forEach(child => {
      const u = child.val();
      u.uid = child.key;
      allUsers.push(u);
    });
  }

  // Listen to user's friends
  function listenToFriends(){
    const friendsRef = db.ref(`friends/${user.uid}`);
    friendsRef.on('value', snapshot => {
      friends = snapshot.exists() ? snapshot.val() : {};
      renderFriends();
    });
  }

  // Render friends list
  function renderFriends(){
    friendsListEl.innerHTML = '';
    const friendUids = Object.keys(friends);
    if(friendUids.length === 0){
      friendsListEl.innerHTML = '<p class="text-center text-gray-400">No friends yet. Search and add some!</p>';
      return;
    }
    friendUids.forEach(uid => {
      const u = allUsers.find(user => user.uid === uid);
      if(!u) return;
      const el = createUserItem(u, false);
      friendsListEl.appendChild(el);
    });
  }

  // Create user item element for friend or search result
  // if isSearchResult=true, add Add Friend button
  function createUserItem(userObj, isSearchResult){
    const container = document.createElement('div');
    container.className = isSearchResult ? 'search-item' : 'friend-item';

    const img = document.createElement('img');
    img.src = userObj.photoURL || 'https://via.placeholder.com/56?text=User';
    img.alt = userObj.displayName;
    img.className = 'friend-photo';

    const info = document.createElement('div');
    info.className = 'friend-info';

    const name = document.createElement('div');
    name.className = 'friend-name';
    name.textContent = userObj.displayName;

    const rating = document.createElement('div');
    rating.className = 'friend-rating';
    rating.textContent = `Rating: ${userObj.rating || 1000}`;

    info.appendChild(name);
    info.appendChild(rating);

    container.appendChild(img);
    container.appendChild(info);

    if(isSearchResult){
      const btn = document.createElement('div');
      btn.className = 'add-friend-btn';
      const isFriend = !!friends[userObj.uid];
      const isRequestSent = friendRequests[userObj.uid] === 'sent'; // local flag to track request sent
      btn.textContent = isFriend ? '‚úî' : (isRequestSent ? '‚úï' : '+');
      if(isFriend){
        btn.classList.add('added');
        btn.title = "Already Friend";
      }
      if(isRequestSent){
        btn.classList.add('added');
        btn.title = "Request Sent. Click to Cancel";
      }
      btn.onclick = async () => {
        if(isFriend) return; // no action on already friend

        if(!isRequestSent){
          // Send friend request
          await db.ref(`friendRequests/${userObj.uid}/${user.uid}`).set(true);
          friendRequests[userObj.uid] = 'sent';
          btn.textContent = '‚úï';
          btn.classList.add('added');
          btn.title = "Request Sent. Click to Cancel";
        } else {
          // Cancel friend request
          await db.ref(`friendRequests/${userObj.uid}/${user.uid}`).remove();
          delete friendRequests[userObj.uid];
          btn.textContent = '+';
          btn.classList.remove('added');
          btn.title = "Add Friend";
        }
      };
      container.appendChild(btn);
    }

    return container;
  }

  // Search friends by username input
  friendSearchInput.addEventListener('input', () => {
    const query = friendSearchInput.value.trim().toLowerCase();
    searchResultsEl.innerHTML = '';
    if(query.length === 0){
      return;
    }
    // Filter users by name fuzzy matching
    const results = allUsers.filter(u => {
      return u.displayName.toLowerCase().includes(query) && u.uid !== user.uid && !friends[u.uid];
    }).slice(0, 10); // limit results

    if(results.length === 0){
      searchResultsEl.innerHTML = '<p class="text-center text-gray-400">No users found.</p>';
      return;
    }

    results.forEach(u => {
      const el = createUserItem(u, true);
      searchResultsEl.appendChild(el);
    });
  });

  // Listen to incoming friend requests
  function listenToFriendRequests(){
    const reqRef = db.ref(`friendRequests/${user.uid}`);
    reqRef.on('value', async snapshot => {
      friendRequests = {};
      if(snapshot.exists()){
        snapshot.forEach(child => {
          friendRequests[child.key] = true;
        });
      }
      updateNotificationUI();
    });
  }

  // Update notification icon badge
  // Update notification icon badge
  function updateNotificationUI(){
    const count = Object.keys(friendRequests).length;
    if(count > 0){
      notificationBadge.style.display = 'inline-block';
      notificationBadge.textContent = count;
    } else {
      notificationBadge.style.display = 'none';
    }
  }

  // Show notification modal with friend requests
  notificationIcon.addEventListener('click', () => {
    renderNotificationList();
    notificationModal.classList.add('active');
  });

  // Close notification modal
  function closeNotificationModal(){
    notificationModal.classList.remove('active');
  }

  // Render friend requests inside notification modal
  function renderNotificationList(){
    notificationList.innerHTML = '';

    const reqUids = Object.keys(friendRequests);
    if(reqUids.length === 0){
      notificationList.innerHTML = '<p class="text-center text-gray-400">No friend requests.</p>';
      return;
    }

    reqUids.forEach(async (fromUid) => {
      // Get sender info from allUsers cache or load from DB if missing
      let sender = allUsers.find(u => u.uid === fromUid);
      if(!sender){
        // fallback: load sender data from DB
        const snap = await db.ref(`users/${fromUid}`).get();
        if(snap.exists()){
          sender = snap.val();
          sender.uid = fromUid;
          allUsers.push(sender); // cache it for later
        }
      }
      if(!sender) return;

      const item = document.createElement('div');
      item.className = 'notification-item';

      const textDiv = document.createElement('div');
      textDiv.className = 'notification-text';
      textDiv.textContent = `${sender.displayName} sent you a friend request.`;

      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'notification-buttons';

      const acceptBtn = document.createElement('div');
      acceptBtn.className = 'notif-btn accept';
      acceptBtn.title = 'Accept Friend Request';
      acceptBtn.textContent = '‚úî';
      acceptBtn.onclick = () => respondToFriendRequest(fromUid, true);

      const declineBtn = document.createElement('div');
      declineBtn.className = 'notif-btn decline';
      declineBtn.title = 'Decline Friend Request';
      declineBtn.textContent = '‚úï';
      declineBtn.onclick = () => respondToFriendRequest(fromUid, false);

      buttonsDiv.appendChild(acceptBtn);
      buttonsDiv.appendChild(declineBtn);

      item.appendChild(textDiv);
      item.appendChild(buttonsDiv);

      notificationList.appendChild(item);
    });
  }

  // Accept or Decline friend request
  async function respondToFriendRequest(fromUid, accept){
    if(accept){
      // Add each other as friends
      const updates = {};
      updates[`friends/${user.uid}/${fromUid}`] = true;
      updates[`friends/${fromUid}/${user.uid}`] = true;
      // Remove the friend request
      updates[`friendRequests/${user.uid}/${fromUid}`] = null;

      await db.ref().update(updates);

    } else {
      // Just remove friend request
      await db.ref(`friendRequests/${user.uid}/${fromUid}`).remove();
    }
  }

</script>

</body>
  </html>
